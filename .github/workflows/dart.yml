name: Flutter CI

on:

  push:

    branches: [ main, test ]

  pull_request:

    branches: [ main, test ]



jobs:

  test:

    runs-on: ubuntu-latest



    steps:

      - name: Checkout repo

        uses: actions/checkout@v3



      - name: Set up Flutter

        uses: subosito/flutter-action@v2

        with:

          flutter-version: '3.29.3'



      - name: Install dependencies

        run: flutter pub get



      - name: Generate mocks

        run: flutter pub run build_runner build --delete-conflicting-outputs



      - name: Format check

        run: dart format . --set-exit-if-changed || true



      - name: Static analysis

        run: |

          flutter analyze > analyze.log || true

          cat analyze.log



      - name: Run tests

        run: flutter test --reporter expanded





  release:


    runs-on: ubuntu-latest


    needs: test


    if: ${{ github.ref == 'refs/heads/test' }}


    steps:


      - name: Checkout code


        uses: actions/checkout@v3


        with:


          fetch-depth: 0





      - name: Setup Git


        run: |


          git config user.name "github-actions"


          git config user.email "github-actions@github.com"





      - name: Make release script executable


        run: chmod +x ./scripts/release.sh





      - name: Run release


        run: ./scripts/release.sh


        env:


          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}